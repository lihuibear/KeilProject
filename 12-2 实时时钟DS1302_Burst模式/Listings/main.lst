C51 COMPILER V9.54   MAIN                                                                  02/17/2024 21:41:28 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\software\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          
   2          #include <reg52.h>
   3          
   4          sbit DS1302_CE = P1^7;
   5          sbit DS1302_CK = P3^5;
   6          sbit DS1302_IO = P3^4;
   7          
   8          bit flag200ms = 0;       //200msÂÆöÊó∂Ê†áÂøó
   9          unsigned char T0RH = 0;  //T0ÈáçËΩΩÂÄºÁöÑÈ´òÂ≠óËäÇ
  10          unsigned char T0RL = 0;  //T0ÈáçËΩΩÂÄºÁöÑ‰ΩéÂ≠óËäÇ
  11          
  12          void ConfigTimer0(unsigned int ms);
  13          void InitDS1302();
  14          void DS1302BurstRead(unsigned char *dat);
  15          extern void InitLcd1602();
  16          extern void LcdShowStr(unsigned char x, unsigned char y, unsigned char *str);
  17          
  18          void main()
  19          {
  20   1          unsigned char psec=0xAA;  //ÁßíÂ§á‰ªΩÔºåÂàùÂÄºAAÁ°Æ‰øùÈ¶ñÊ¨°ËØªÂèñÊó∂Èó¥Âêé‰ºöÂà∑Êñ∞ÊòæÁ§∫
  21   1          unsigned char time[8];    //ÂΩìÂâçÊó∂Èó¥Êï∞ÁªÑ
  22   1          unsigned char str[12];    //Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢ÁºìÂÜ≤Âå∫
  23   1      
  24   1          EA = 1;           //ÂºÄÊÄª‰∏≠Êñ≠
  25   1          ConfigTimer0(1);  //T0ÂÆöÊó∂1ms
  26   1          InitDS1302();     //ÂàùÂßãÂåñÂÆûÊó∂Êó∂Èíü
  27   1          InitLcd1602();    //ÂàùÂßãÂåñÊ∂≤Êô∂
  28   1          
  29   1          while (1)
  30   1          {
  31   2              if (flag200ms)  //ÊØè200msËØªÂèñ‰æùÊ¨°Êó∂Èó¥
  32   2              {
  33   3                  flag200ms = 0;
  34   3                  DS1302BurstRead(time); //ËØªÂèñDS1302ÂΩìÂâçÊó∂Èó¥
  35   3                  if (psec != time[0])   //Ê£ÄÊµãÂà∞Êó∂Èó¥ÊúâÂèòÂåñÊó∂Âà∑Êñ∞ÊòæÁ§∫
  36   3                  {
  37   4                      str[0] = '2';  //Ê∑ªÂä†Âπ¥‰ªΩÁöÑÈ´ò2‰ΩçÔºö20
  38   4                      str[1] = '0';
  39   4                      str[2] = (time[6] >> 4) + '0';  //‚ÄúÂπ¥‚ÄùÈ´ò‰ΩçÊï∞Â≠óËΩ¨Êç¢‰∏∫ASCIIÁ†Å
  40   4                      str[3] = (time[6]&0x0F) + '0';  //‚ÄúÂπ¥‚Äù‰Ωé‰ΩçÊï∞Â≠óËΩ¨Êç¢‰∏∫ASCIIÁ†Å
  41   4                      str[4] = '-';  //Ê∑ªÂä†Êó•ÊúüÂàÜÈöîÁ¨¶
  42   4                      str[5] = (time[4] >> 4) + '0';  //‚ÄúÊúà‚Äù
  43   4                      str[6] = (time[4]&0x0F) + '0';
  44   4                      str[7] = '-';
  45   4                      str[8] = (time[3] >> 4) + '0';  //‚ÄúÊó•‚Äù
  46   4                      str[9] = (time[3]&0x0F) + '0';
  47   4                      str[10] = '\0';
  48   4                      LcdShowStr(0, 0, str);  //ÊòæÁ§∫Âà∞Ê∂≤Êô∂ÁöÑÁ¨¨‰∏ÄË°å
  49   4                      
  50   4                      str[0] = (time[5]&0x0F) + '0';  //‚ÄúÊòüÊúü‚Äù
  51   4                      str[1] = '\0';
  52   4                      LcdShowStr(11, 0, "week");
  53   4                      LcdShowStr(15, 0, str);  //ÊòæÁ§∫Âà∞Ê∂≤Êô∂ÁöÑÁ¨¨‰∏ÄË°å
  54   4                      
C51 COMPILER V9.54   MAIN                                                                  02/17/2024 21:41:28 PAGE 2   

  55   4                      str[0] = (time[2] >> 4) + '0';  //‚ÄúÊó∂‚Äù
  56   4                      str[1] = (time[2]&0x0F) + '0';
  57   4                      str[2] = ':';  //Ê∑ªÂä†Êó∂Èó¥ÂàÜÈöîÁ¨¶
  58   4                      str[3] = (time[1] >> 4) + '0';  //‚ÄúÂàÜ‚Äù
  59   4                      str[4] = (time[1]&0x0F) + '0';
  60   4                      str[5] = ':';
  61   4                      str[6] = (time[0] >> 4) + '0';  //‚ÄúÁßí‚Äù
  62   4                      str[7] = (time[0]&0x0F) + '0';
  63   4                      str[8] = '\0';
  64   4                      LcdShowStr(4, 1, str);  //ÊòæÁ§∫Âà∞Ê∂≤Êô∂ÁöÑÁ¨¨‰∫åË°å
  65   4                      
  66   4                      psec = time[0];  //Áî®ÂΩìÂâçÂÄºÊõ¥Êñ∞‰∏äÊ¨°ÁßíÊï∞
  67   4                  }
  68   3              }
  69   2          }
  70   1      }
  71          
  72          /* ÂèëÈÄÅ‰∏Ä‰∏™Â≠óËäÇÂà∞DS1302ÈÄö‰ø°ÊÄªÁ∫ø‰∏ä */
  73          void DS1302ByteWrite(unsigned char dat)
  74          {
  75   1          unsigned char mask;
  76   1          
  77   1          for (mask=0x01; mask!=0; mask<<=1)  //‰Ωé‰ΩçÂú®ÂâçÔºåÈÄê‰ΩçÁßªÂá∫
  78   1          {
  79   2              if ((mask&dat) != 0) //È¶ñÂÖàËæìÂá∫ËØ•‰ΩçÊï∞ÊçÆ
  80   2                  DS1302_IO = 1;
  81   2              else
  82   2                  DS1302_IO = 0;
  83   2              DS1302_CK = 1;       //ÁÑ∂ÂêéÊãâÈ´òÊó∂Èíü
  84   2              DS1302_CK = 0;       //ÂÜçÊãâ‰ΩéÊó∂ÈíüÔºåÂÆåÊàê‰∏Ä‰∏™‰ΩçÁöÑÊìç‰Ωú
  85   2          }
  86   1          DS1302_IO = 1;           //ÊúÄÂêéÁ°Æ‰øùÈáäÊîæIOÂºïËÑö
  87   1      }
  88          /* Áî±DS1302ÈÄö‰ø°ÊÄªÁ∫ø‰∏äËØªÂèñ‰∏Ä‰∏™Â≠óËäÇ */
  89          unsigned char DS1302ByteRead()
  90          {
  91   1          unsigned char mask;
  92   1          unsigned char dat = 0;
  93   1          
  94   1          for (mask=0x01; mask!=0; mask<<=1)  //‰Ωé‰ΩçÂú®ÂâçÔºåÈÄê‰ΩçËØªÂèñ
  95   1          {
  96   2              if (DS1302_IO != 0)  //È¶ñÂÖàËØªÂèñÊ≠§Êó∂ÁöÑIOÂºïËÑöÔºåÂπ∂ËÆæÁΩÆdat‰∏≠ÁöÑÂØπÂ∫î‰Ωç
  97   2              {
  98   3                  dat |= mask;
  99   3              }
 100   2              DS1302_CK = 1;       //ÁÑ∂ÂêéÊãâÈ´òÊó∂Èíü
 101   2              DS1302_CK = 0;       //ÂÜçÊãâ‰ΩéÊó∂ÈíüÔºåÂÆåÊàê‰∏Ä‰∏™‰ΩçÁöÑÊìç‰Ωú
 102   2          }
 103   1          return dat;              //ÊúÄÂêéËøîÂõûËØªÂà∞ÁöÑÂ≠óËäÇÊï∞ÊçÆ
 104   1      }
 105          /* Áî®ÂçïÊ¨°ÂÜôÊìç‰ΩúÂêëÊüê‰∏ÄÂØÑÂ≠òÂô®ÂÜôÂÖ•‰∏Ä‰∏™Â≠óËäÇÔºåreg-ÂØÑÂ≠òÂô®Âú∞ÂùÄÔºådat-ÂæÖÂÜôÂÖ•Â≠óËäÇ */
 106          void DS1302SingleWrite(unsigned char reg, unsigned char dat)
 107          {
 108   1          DS1302_CE = 1;                   //‰ΩøËÉΩÁâáÈÄâ‰ø°Âè∑
 109   1          DS1302ByteWrite((reg<<1)|0x80);  //ÂèëÈÄÅÂÜôÂØÑÂ≠òÂô®Êåá‰ª§
 110   1          DS1302ByteWrite(dat);            //ÂÜôÂÖ•Â≠óËäÇÊï∞ÊçÆ
 111   1          DS1302_CE = 0;                   //Èô§ËÉΩÁâáÈÄâ‰ø°Âè∑
 112   1      }
 113          /* Áî®ÂçïÊ¨°ËØªÊìç‰Ωú‰ªéÊüê‰∏ÄÂØÑÂ≠òÂô®ËØªÂèñ‰∏Ä‰∏™Â≠óËäÇÔºåreg-ÂØÑÂ≠òÂô®Âú∞ÂùÄÔºåËøîÂõûÂÄº-ËØªÂà∞ÁöÑÂ≠óËä
             -Ç */
 114          unsigned char DS1302SingleRead(unsigned char reg)
 115          {
C51 COMPILER V9.54   MAIN                                                                  02/17/2024 21:41:28 PAGE 3   

 116   1          unsigned char dat;
 117   1          
 118   1          DS1302_CE = 1;                   //‰ΩøËÉΩÁâáÈÄâ‰ø°Âè∑
 119   1          DS1302ByteWrite((reg<<1)|0x81);  //ÂèëÈÄÅËØªÂØÑÂ≠òÂô®Êåá‰ª§
 120   1          dat = DS1302ByteRead();          //ËØªÂèñÂ≠óËäÇÊï∞ÊçÆ
 121   1          DS1302_CE = 0;                   //Èô§ËÉΩÁâáÈÄâ‰ø°Âè∑
 122   1          
 123   1          return dat;
 124   1      }
 125          void  DS1302BurstWrite(unsigned char *dat)
 126          {
 127   1        unsigned char i;
 128   1      
 129   1        DS1302_CE = 1;
 130   1        DS1302ByteWrite(0xBE);
 131   1        for(i=0; i<8; i++)
 132   1        {
 133   2          DS1302ByteWrite(dat[i]);
 134   2        }
 135   1        DS1302_CE = 0;
 136   1      }
 137          
 138          void  DS1302BurstRead(unsigned char *dat)
 139          {
 140   1        unsigned char i;
 141   1      
 142   1        DS1302_CE = 1;
 143   1        DS1302ByteWrite(0xBF);
 144   1        for(i=0; i<8; i++)
 145   1        {
 146   2          dat[i] = DS1302ByteRead();
 147   2        }
 148   1        DS1302_CE = 0;
 149   1      }
 150          /* DS1302ÂàùÂßãÂåñÔºåÂ¶ÇÂèëÁîüÊéâÁîµÂàôÈáçÊñ∞ËÆæÁΩÆÂàùÂßãÊó∂Èó¥ */
 151          void InitDS1302()
 152          {
 153   1          unsigned char dat;
 154   1          unsigned char code InitTime[] = {  //
 155   1              0x00,0x30,0x12, 0x08, 0x10, 0x02, 0x25
 156   1          };
 157   1          
 158   1          DS1302_CE = 0;  //ÂàùÂßãÂåñDS1302ÈÄö‰ø°ÂºïËÑö
 159   1          DS1302_CK = 0;
 160   1          dat = DS1302SingleRead(0);  //ËØªÂèñÁßíÂØÑÂ≠òÂô®
 161   1          if ((dat & 0x80) != 0)      //Áî±ÁßíÂØÑÂ≠òÂô®ÊúÄÈ´ò‰ΩçCHÁöÑÂÄºÂà§Êñ≠DS1302ÊòØÂê¶Â∑≤ÂÅúÊ≠¢
 162   1          {
 163   2              DS1302SingleWrite(7, 0x00);  //Êí§ÈîÄÂÜô‰øùÊä§‰ª•ÂÖÅËÆ∏ÂÜôÂÖ•Êï∞ÊçÆ
 164   2              DS1302BurstWrite(InitTime);  //ËÆæÁΩÆDS1302‰∏∫ÈªòËÆ§ÁöÑÂàùÂßãÊó∂Èó¥
 165   2          }
 166   1      }
 167          /* ÈÖçÁΩÆÂπ∂ÂêØÂä®T0Ôºåms-T0ÂÆöÊó∂Êó∂Èó¥ */
 168          void ConfigTimer0(unsigned int ms)
 169          {
 170   1          unsigned long tmp;  //‰∏¥Êó∂ÂèòÈáè
 171   1          
 172   1          tmp = 11059200 / 12;      //ÂÆöÊó∂Âô®ËÆ°Êï∞È¢ëÁéá
 173   1          tmp = (tmp * ms) / 1000;  //ËÆ°ÁÆóÊâÄÈúÄÁöÑËÆ°Êï∞ÂÄº
 174   1          tmp = 65536 - tmp;        //ËÆ°ÁÆóÂÆöÊó∂Âô®ÈáçËΩΩÂÄº
 175   1          tmp = tmp + 12;           //Ë°•ÂÅø‰∏≠Êñ≠ÂìçÂ∫îÂª∂Êó∂ÈÄ†ÊàêÁöÑËØØÂ∑Æ
 176   1          T0RH = (unsigned char)(tmp>>8);  //ÂÆöÊó∂Âô®ÈáçËΩΩÂÄºÊãÜÂàÜ‰∏∫È´ò‰ΩéÂ≠óËäÇ
 177   1          T0RL = (unsigned char)tmp;
C51 COMPILER V9.54   MAIN                                                                  02/17/2024 21:41:28 PAGE 4   

 178   1          TMOD &= 0xF0;   //Ê∏ÖÈõ∂T0ÁöÑÊéßÂà∂‰Ωç
 179   1          TMOD |= 0x01;   //ÈÖçÁΩÆT0‰∏∫Ê®°Âºè1
 180   1          TH0 = T0RH;     //Âä†ËΩΩT0ÈáçËΩΩÂÄº
 181   1          TL0 = T0RL;
 182   1          ET0 = 1;        //‰ΩøËÉΩT0‰∏≠Êñ≠
 183   1          TR0 = 1;        //ÂêØÂä®T0
 184   1      }
 185          /* T0‰∏≠Êñ≠ÊúçÂä°ÂáΩÊï∞ÔºåÊâßË°å200msÂÆöÊó∂ */
 186          void InterruptTimer0() interrupt 1
 187          {
 188   1          static unsigned char tmr200ms = 0;
 189   1          
 190   1          TH0 = T0RH;  //ÈáçÊñ∞Âä†ËΩΩÈáçËΩΩÂÄº
 191   1          TL0 = T0RL;
 192   1          tmr200ms++;
 193   1          if (tmr200ms >= 200)  //ÂÆöÊó∂200ms
 194   1          {
 195   2              tmr200ms = 0;
 196   2              flag200ms = 1;
 197   2          }
 198   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    574    ----
   CONSTANT SIZE    =     12    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3      31
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
